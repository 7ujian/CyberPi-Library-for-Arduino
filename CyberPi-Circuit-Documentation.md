# CyberPi 电路文档

## 1. 核心芯片与模块

### 1.1 主控制器
- **芯片型号**: ESP32（从驱动代码推断）
- **主要功能**: 系统核心控制，运行FreeRTOS实时操作系统
- **主要接口**: I2C、SPI、GPIO等

### 1.2 GPIO扩展芯片
- **芯片型号**: AW9523B（2个）
- **I2C地址**: 0x5b 和 0x58
- **主要功能**: 扩展ESP32的GPIO引脚，提供更多输入输出接口
- **端口配置**: 
  - 每个芯片提供2个8位端口（P0和P1）
  - 支持GPIO和LED模式
  - 支持推挽和开漏输出模式

### 1.3 显示模块
- **芯片型号**: ST7789 LCD驱动
- **屏幕参数**: 128x128像素彩色TFT LCD
- **通讯接口**: SPI

### 1.4 陀螺仪与加速度计
- **芯片型号**: MPU6887
- **I2C地址**: 0x69
- **主要功能**: 提供三轴加速度和三轴陀螺仪数据

### 1.5 音频模块
- **芯片型号**: ES8218E
- **I2C地址**: 0x10
- **主要功能**: 仅音频输入（麦克风）处理

### 1.6 音频输出
- **实现方式**: ESP32片上DAC
- **驱动方式**: 
  - Legacy: I2S接口驱动
  - ESP32 3.x API: dac_continuous模式驱动

### 1.7 字体芯片
- **芯片型号**: GT30L24A3W
- **主要功能**: 提供多语言字库支持，包括ASCII、中文、日文、韩文、拉丁文等多种语言字体
- **字体规格**: 支持多种字号，包括5x7、7x8、6x12、12x12、8x16、12x24、16x32、16x16、24x24、32x32等
- **通讯接口**: SPI

## 2. 主要模块硬件连接

### 2.1 I2C总线连接
| 设备 | I2C地址 | 连接引脚 | 功能 |
|------|---------|---------|------|
| AW9523B #1 | 0x5b | SCL=18, SDA=19 | GPIO扩展 |
| AW9523B #2 | 0x58 | SCL=18, SDA=19 | GPIO扩展 |
| MPU6887 | 0x69 | SCL=18, SDA=19 | 陀螺仪/加速度计 |
| ES8218E | 0x10 | SCL=18, SDA=19 | 麦克风输入处理 |

### 2.2 LCD显示模块连接
| LCD引脚 | ESP32/GPIO扩展引脚 | 功能 |
|---------|------------------|------|
| MOSI | 2 | 数据输出 |
| MISO | 26 | 数据输入（用于字库） |
| CLK | 4 | 时钟信号 |
| CS | 12 | 片选信号 |
| DC | AW_P1_4 | 数据/命令选择 |
| RESET | AW_P1_5 | 复位信号 |
| BL | AW_P1_7 | 背光控制 |

### 2.3 字体芯片GT30L24A3W连接
| GT30L24A3W引脚 | ESP32引脚 | 功能 |
|---------------|----------|------|
| MOSI | 2 | 数据输出 |
| MISO | 26 | 数据输入 |
| CLK | 4 | 时钟信号 |
| CS | 27 | 片选信号 |

### 2.4 AW9523B GPIO扩展引脚定义

**AW9523B #2 (地址0x58)引脚定义**: 
| 引脚名 | 功能 |
|--------|------|
| AW_P0_0 - AW_P0_7 | P0端口GPIO/LED |
| AW_P1_0 - AW_P1_7 | P1端口GPIO/LED |
| AW_P1_4 | LCD DC控制 |
| AW_P1_5 | LCD RESET控制 |
| AW_P1_7 | LCD背光控制 |

## 3. 通讯接口配置

### 3.1 I2C接口
- **端口号**: I2C_NUM_1
- **时钟频率**: 400kHz
- **引脚定义**: 
  - SCL: GPIO18
  - SDA: GPIO19
- **配置**: 无缓冲模式

### 3.2 SPI接口 (LCD专用)
- **端口号**: SPI_NUM_1
- **时钟频率**: 20MHz
- **引脚定义**: 
  - CLK: GPIO4
  - MOSI: GPIO2
  - MISO: GPIO26
  - CS: GPIO12
- **配置**: 用于LCD数据传输

### 3.3 SPI接口 (字库芯片专用)
- **端口号**: SPI_NUM_1
- **时钟频率**: 20MHz
- **引脚定义**: 
  - CLK: GPIO4
  - MOSI: GPIO2
  - MISO: GPIO26
  - CS: GPIO27
- **配置**: 用于GT30L24A3W字库芯片数据传输
  - SPI模式: 0 (CPOL=0, CPHA=0)
  - 读命令: 0x03
  - 地址格式: 24位地址

## 4. 模块初始化与配置

### 4.1 AW9523B初始化流程
1. 软复位：向REG_SWRST寄存器写入0x00
2. 配置端口模式：设置为GPIO或LED模式
3. 配置输出模式：推挽或开漏
4. 设置初始输出状态

### 4.2 MPU6887初始化流程
1. 关闭睡眠模式：PWR_MGMT_1 = 0x00
2. 配置数字低通滤波器：CONFIG = 0x01
3. 设置陀螺仪量程：500 deg/s (GYRO_CONFIG = 0x08)
4. 设置加速度计量程：4g (ACCEL_CONFIG = 0x08)
5. 设置采样率：100Hz (SMPLRT_DI = 0x09)

### 4.3 ST7789 LCD初始化流程
1. 硬件复位
2. 发送初始化命令序列
3. 配置显示参数（分辨率、颜色模式等）
4. 开启显示

### 4.4 ES8218E麦克风输入模块初始化流程
1. 配置时钟管理寄存器
2. 设置串口数据端口
3. 配置系统控制寄存器
4. 设置ADC参数
5. 配置输入通道

## 5. 系统架构与数据流

### 5.1 系统架构
- **主控制器**: ESP32运行FreeRTOS
- **扩展接口**: 通过I2C连接多个外设芯片
- **显示系统**: SPI连接ST7789 LCD，独立线程渲染
- **传感器系统**: MPU6887提供运动数据
- **音频输入系统**: ES8218E处理麦克风输入
- **音频输出系统**: ESP32片上DAC实现音频输出

### 5.2 主要数据流
1. **显示数据**: ESP32 → SPI → ST7789 → LCD
2. **字库数据**: ESP32 → SPI(CS=27) → GT30L24A3W → SPI → ESP32
3. **传感器数据**: MPU6887 → I2C → ESP32
4. **GPIO控制**: ESP32 → I2C → AW9523B → 外设
5. **音频输入数据**: 麦克风 → ES8218E → I2C控制 → ESP32
6. **音频输出数据**: ESP32 → 片上DAC → 音频输出

## 6. 关键寄存器与配置

### 6.1 AW9523B关键寄存器
- **REG_SWRST (0x7F)**: 软复位寄存器
- **REG_WORK_MODE_P0 (0x12)**: P0端口工作模式
- **REG_WORK_MODE_P1 (0x13)**: P1端口工作模式
- **REG_OUTPUT_P0 (0x02)**: P0端口输出状态
- **REG_OUTPUT_P1 (0x03)**: P1端口输出状态

### 6.2 MPU6887关键寄存器
- **WHO_AM_I (0x75)**: 设备ID寄存器
- **PWR_MGMT_1 (0x6B)**: 电源管理寄存器
- **GYRO_CONFIG (0x1B)**: 陀螺仪配置寄存器
- **ACCEL_CONFIG (0x1C)**: 加速度计配置寄存器
- **ACCEL_XOUT_H (0x3B)**: 加速度计X轴数据高8位

### 6.3 ST7789关键命令
- **SWRESET (0x01)**: 软复位
- **SLPOUT (0x11)**: 退出睡眠模式
- **DISPON (0x29)**: 开启显示
- **CASET (0x2A)**: 设置列地址
- **RASET (0x2B)**: 设置行地址
- **RAMWR (0x2C)**: 写入显示数据

## 7. 硬件设计特点

### 7.1 模块化设计
- 采用多个专用芯片实现不同功能
- 通过标准通讯接口连接，便于维护和扩展

### 7.2 高效通讯
- 主要外设采用I2C接口，简化布线
- LCD采用高速SPI接口，保证显示性能

### 7.3 电源管理
- 支持低功耗模式
- 各模块可独立控制电源状态

### 7.4 信号完整性
- 合理的引脚分配和信号路由
- 支持信号滤波和抗干扰设计

## 8. 总结

CyberPi采用ESP32作为主控制器，通过I2C和SPI接口连接多个专用功能模块，包括AW9523B GPIO扩展、ST7789 LCD显示、MPU6887陀螺仪和ES8218E麦克风输入模块。音频输出采用ESP32片上DAC实现。这种模块化设计提供了丰富的功能和良好的扩展性，同时通过标准通讯接口保证了系统的可靠性和稳定性。

系统采用FreeRTOS实时操作系统，实现了多任务并行处理，包括LCD渲染、传感器数据采集、音频处理等功能，为用户提供了流畅的交互体验和丰富的功能支持。